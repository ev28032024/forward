# Forward Monitor

Лёгкий асинхронный мост между каналами Discord и чатами Telegram. Бот отслеживает новые сообщения,
очищает их, при необходимости нарезает на несколько частей и отправляет в указанные чаты Telegram.

## Возможности
- **Красивое оформление сообщений.** Можно добавлять “чипы” (небольшие метки), заголовки и подвал. Текстовые замены (find/replace) делаются аккуратно - без повторяющихся строк.
- **Удобная работа с вложениями.** Вложения и embed-блоки сворачиваются в короткие подписи, при этом HTML-разметка сохраняется.
- **Гибкие фильтры.** Можно отфильтровать сообщения по словам, отправителям и типам (только текст, только с файлами и т. п.).
- **Профили для Telegram.** Для каждого канала/бота настраиваются: режим разметки (Markdown/HTML), показ/скрытие превью ссылок, лимиты длины и как перечислять вложения.
- **Контроль скорости и сети.** Отдельные лимиты отправки для Discord и Telegram, поддержка пулов прокси и своих user-agent’ов.
- **Надёжное состояние и тайминги.** Прогресс хранится в файле (state_file), есть настраиваемые интервалы опроса и случайные задержки между отправками, чтобы не выглядеть как спам-бот.

## Установка
1. Создайте и активируйте виртуальное окружение.
2. Установите зависимости и проект в режиме разработки.
3. Скопируйте пример конфигурации и заполните обязательные поля.
4. Запустите бота, передав путь к конфигурации.

```bash
python3 -m venv .venv
source .venv/bin/activate
pip3 install -e .[dev]
cp config.example.yml config.yml
python3 -m forward_monitor --config config.yml
```

## Быстрый старт
Минимально необходимый `config.yml` должен содержать токены и хотя бы одну пару каналов:

```yaml
telegram:
  token: "TELEGRAM_BOT_TOKEN"
  chat: "@fallback_channel"

discord:
  token: "DISCORD_USER_TOKEN"

forward:
  channels:
    - discord: 123456789012345678
      telegram: "-1001234567890"
```

`token_type` у Discord подбирается автоматически (`auto`), но при необходимости можно указать `user`,
`bot` или `bearer`.

## Конфигурация
Forward Monitor настраивается YAML-файлом. Полный список параметров с дефолтами и
комментариями — в [`config.example.yml`](config.example.yml). Ниже приведено
краткое описание каждой секции.

### Telegram
Обязательные поля — `token` и `chat`. Остальное опционально, но уже имеет
значения по умолчанию.

- `rate_limit.per_second` (`0.8`) — ограничения на скорость отправки; `null`
  включает расчёт по умолчанию самого API.
- `rate_limit.per_minute` (`25`), `concurrency` (`1`), `jitter_min_ms` (`60`),
  `jitter_max_ms` (`200`) и `cooldown_seconds` (`30`) регулируют частоту и
  паузы при повторных запросах.【F:src/forward_monitor/config.py†L47-L78】【F:config.example.yml†L5-L20】
- `formatting` определяет Telegram-профиль: `parse_mode` (`HTML`),
  `disable_link_preview` (`true`), `max_length` (`3500`), `ellipsis` (`…`),
  `attachments_style` (`minimal`).【F:src/forward_monitor/config.py†L169-L248】【F:config.example.yml†L15-L20】

### Discord
Минимум — поле `token`. По умолчанию используется `token_type: auto`, который
подбирает схему авторизации самостоятельно.【F:src/forward_monitor/config.py†L522-L531】

- Лимиты из `rate_limit` включают `per_second` (`4.0`), `per_minute` (`60`),
  `concurrency` (`4`), `jitter_min_ms` (`40`), `jitter_max_ms` (`160`) и
  `cooldown_seconds` (`30`). Эти параметры задают мягкий троттлинг запросов к
  Discord и используются ограничителем SoftRateLimiter.【F:src/forward_monitor/config.py†L33-L75】【F:config.example.yml†L22-L33】

### Forward
Секция отвечает за обработку и маршрутизацию сообщений.

#### forward.defaults
- `filters` содержит белые/чёрные списки слов (`whitelist`/`blacklist`),
  авторов (`allowed_senders`/`blocked_senders`) и типов сообщений
  (`allowed_types`/`blocked_types`). Поддерживаемые типы: `text`, `attachment`,
  `image`, `video`, `audio`, `file`, `document`, `other`. Пустые значения не
  учитываются.【F:src/forward_monitor/config.py†L262-L337】【F:config.example.yml†L35-L43】
- `text` управляет декоративными элементами (чипы, заголовки, подвал) и
  правилами find/replace, применяемыми до Telegram-разметки.【F:src/forward_monitor/config.py†L338-L425】【F:config.example.yml†L44-L51】
- `formatting` позволяет переопределить профиль Telegram для всех каналов.
  Если параметр не указан, берётся глобальный формат из секции `telegram`.
  Доступны те же поля, что описаны выше.【F:src/forward_monitor/config.py†L169-L248】【F:config.example.yml†L52-L58】

#### forward.channels
Каждая запись определяет пару «Discord → Telegram» и может уточнять любые
настройки из `defaults`.

- `discord` — числовой ID канала Discord; `telegram` — chat_id или @username.
- `name` — произвольная подпись для логов; `null` отключает её.
- Вложенные блоки `filters`, `text`, `formatting` работают так же, как в
  `defaults`, но применяются только к конкретному каналу и объединяются с
  базовыми значениями (в частности, списки склеиваются, а замены дополняются).【F:src/forward_monitor/config.py†L560-L620】【F:config.example.yml†L59-L96】

### Network
Настройки сетевого слоя применяются к обоим ботам.

- `user_agents.desktop` и `user_agents.mobile` могут переопределить встроенные
  списки браузеров; пустые списки означают использование дефолтных значений.
  `mobile_ratio` (`0.35`) — доля запросов, имитирующих мобильные устройства.【F:src/forward_monitor/config.py†L88-L123】【F:config.example.yml†L99-L104】
- `proxies.pool` задаёт общий пул прокси; `username`, `password`,
  `rotate_url` добавляют базовые креденшлы и URL смены IP. Разделы
  `discord`/`telegram` позволяют переопределить параметры для конкретного
  сервиса. Альтернативно можно передать `credentials` в формате `user:pass`.
  Блок `healthcheck` включает URL проверки доступности, таймаут и период
  восстановления пула.【F:src/forward_monitor/config.py†L624-L858】【F:config.example.yml†L105-L119】

### Runtime
Управляет опросом Discord и отправкой в Telegram.

- `poll_every` (`300`) — интервал опроса, секунды. `state_file` — путь к файлу
  состояния для продолжения при перезапуске.
- `max_messages` (`1000`) ограничивает число сообщений, которые бот заберёт из
  канала за один проход; `max_fetch_seconds` (`5.0`) — предел ожидания
  API Discord.
- `delays.min` (`0.5`) и `delays.max` (`2.0`) определяют случайный диапазон
  пауз перед отправкой сообщений в Telegram.【F:src/forward_monitor/config.py†L594-L656】【F:config.example.yml†L121-L128】

## Принцип работы
1. Discord опрашивается с периодом `runtime.poll_every` (по умолчанию 5 минут).
2. Сообщения проходят фильтры, замены и очистку Markdown.
3. Telegram получает основное сообщение и вложения отдельными компактными блоками.
4. Состояние доставки сохраняется в `state_file`, чтобы бот мог продолжить после перезапуска.

## Разработка
Установите инструменты разработки и активируйте git-hook'и:

```bash
pip3 install -U ruff mypy pytest pytest-asyncio aresponses pre-commit
pre-commit install
pre-commit install --hook-type pre-push
```

Хук `pre-push` запускает `pytest -q` перед отправкой коммитов. Если тесты падают, push будет
отклонён до исправления проблемы.

## CI и тестирование

Для локальной проверки перед коммитом запустите полную цепочку:

```bash
make ci
```

Команда последовательно выполняет `ruff`, `mypy` и `pytest`. Если какой-либо этап завершился
ошибкой:

- `ruff` сообщает о синтаксических, импортных и стилистических нарушениях. Исправьте код вручную
  или выполните `ruff --fix`/`ruff format`, затем повторно запустите `make ci`.
- `mypy` проверяет статические типы и ожидаемые контракты. Уточните аннотации типов, протоколы или
  TypedDict'ы согласно сообщениям об ошибках.
- `pytest` выявляет регрессы и ошибки исполнения. Проанализируйте трассировку, воспроизведите
  проблему локально и исправьте исходный код (не тесты), чтобы тесты проходили стабильно.

Все коммиты и merge-запросы должны проходить `make ci`. Слияние в основную ветку запрещено, пока CI
не зелёный.
