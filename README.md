# Forward Monitor (Telegram-first)

Forward Monitor — лёгкий мост между Discord и Telegram. Теперь все настройки живут в Telegram-боте: вы запускаете процесс один раз, привязываете администраторов и управляете каналами, фильтрами и прокси прямо из чата.

## Возможности
- **Полностью удалённое управление.** Добавление каналов, настройка фильтров, выбор токенов, user-agent'ов и прокси осуществляется командами бота.
- **Быстрая обработка.** Минимум зависимостей, компактная в памяти архитектура, асинхронные клиенты для обоих API.
- **Гибкие фильтры.** Белые и чёрные списки слов, отправителей и типов вложений, find/replace-правила для текста.
- **Информативное форматирование.** Настраиваемые шапки и подписи, Markdown/HTML/текстовый режимы, краткие или полные списки вложений, автоматическое разбиение на сообщения.
- **Сетевые опции.** Прокси и user-agent для Discord и Telegram, регулировка доли мобильных запросов, независимые лимиты скорости.

## Установка
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -e .[dev]
```

## Запуск
1. Получите токен Telegram-бота у BotFather.
2. Запустите монитор:
   ```bash
   export FORWARD_TELEGRAM_TOKEN="123:ABC"
   python -m forward_monitor --db-path forward.db
   ```
3. Откройте чат с ботом и отправьте `/start`, затем `/claim`, чтобы назначить себя администратором.
4. Настраивайте каналы и параметры командами (см. ниже).

> **Примечание.** Токен Discord задаётся из Telegram командой `/set_discord_token`. До этого момента мост не будет опрашивать каналы.

## Основные команды
Команды вводятся в чате с ботом. В скобках указано, нужно ли быть администратором.

- `/start` — краткое приветствие (без прав).
- `/help` — полный список команд (без прав).
- `/claim` — стать первым администратором (без прав, если список пуст).
- `/admins` — список администраторов (админ).
- `/grant <id>` / `/revoke <id>` — выдать/отобрать права (админ).
- `/status` — текущее состояние, каналы, лимиты (без прав).
- `/set_discord_token <token>` — сохранить токен Discord (админ).
- `/set_fallback_chat <chat_id>` — задать запасной чат для служебных сообщений (админ).
- `/add_channel <discord_id> <telegram_chat> [метка]` — добавить связку (админ).
- `/remove_channel <discord_id>` — удалить связку (админ).
- `/list_channels` — показать текущие связки (админ).
- `/set_header|/set_footer|/set_chip <discord_id|all> <текст>` — декор сообщений (админ).
- `/set_parse_mode <discord_id|all> <markdownv2|markdown|html|text>` — режим форматирования (админ).
- `/set_disable_preview <discord_id|all> <on|off>` — предпросмотр ссылок (админ).
- `/set_max_length <discord_id|all> <число>` — максимум символов (админ).
- `/set_attachments <discord_id|all> <summary|links>` — стиль сводки вложений (админ).
- `/add_filter <discord_id|all> <тип> <значение>` — добавить фильтр (тип: `whitelist`, `blacklist`, `allowed_senders`, `blocked_senders`, `allowed_types`, `blocked_types`).
- `/clear_filter <discord_id|all> <тип> [значение]` — удалить фильтры.
- `/add_replace <discord_id|all> шаблон => замена` — find/replace.
- `/clear_replace <discord_id|all> [шаблон]` — удалить find/replace.
- `/set_proxy <discord|telegram|clear> [url]` — прокси для сервисов.
- `/set_user_agent <desktop|mobile> <ua>` — user-agent для Discord.
- `/set_mobile_ratio <0-1>` — доля запросов от мобильного UA.
- `/set_poll <секунды>` — период опроса Discord.
- `/set_delay <min_ms> <max_ms>` — случайная пауза между отправками.
- `/set_rate <discord|telegram> <в_секунду>` — предел запросов в секунду.

Команды `all` или `*` на месте идентификатора канала меняют глобальные значения для всех связок.

## Схема работы
1. Бот Telegram принимает команды и сохраняет настройки в локальную SQLite-базу (`forward.db`).
2. Монитор регулярно опрашивает указанные Discord-каналы, применяет фильтры и преобразования.
3. Сообщения отправляются в Telegram с учётом лимитов и настроек оформления.

## Тесты и проверка
```bash
pytest
```

## Бенчмарк
Скрипт `scripts/bench.py` сравнивает скорость форматирования старого и нового пайплайнов.

```bash
python scripts/bench.py
```

Результаты и выводы — в [bench.md](bench.md).

## Лицензия
MIT
